# 软件交付问题

软件发布当天往往紧张且风险很高，因为很多项目中都是需要很多手工操作的过程。

运维安装好系统环境， 软件包复制到生产主机然后创建配置信息，最后启动程序。

## 发布反模式

发布反模式是指在软件交付过程中，采用了一些不合理的做法，导致了效率低下、错误频发、沟通不畅等问题。

软件发布当天往往紧张且风险很高.

### 反模式1：手动发布

手动发布是最常见的反模式， 需要很多人参与。

无论软件规模，部署过程都会一定的复杂， 如果每个步骤里都有人为执行，那么很容易出错。 且由于执行顺序和时机结果也会有差异。

这些**反模式**特征如下：

- 详细文档： 描述了每个步骤及注意事项
- 手动测试一遍
- 开发团队频繁的沟通协调
- 发布时线上bug需要重新部署
- 发布时长过长
- 不可预测的后果
- 加班疲累

### 反模式2：开发完成才部署灰度

这种模式下，第一次部署到灰度环境意味着**大部分工作已经完成**。

那么通常会有一下情况：

- 测试人员已经经过一轮开发环境测试
- 运维人员对部署前的程序毫不知情，压力大
- 可能环境权限对于特定需求的限制，导致开发人员未能自测

有些问题部署到灰度环境才会发现， 但这时项目工期并不允许再进行一次完整的测试。 **推迟发布日期时不会被人接受的**。

:::danger

情况可能会更糟！如下这些常见问题：

1. 全新开发的程序，第一次部署到灰度，会非常棘手。 协调各种资源。
1. 交付过程被划分为开发、DBA、运维、测试等多个角色， 需要协调沟通。
1. 环境差异大，开发与现实遇到的情况相差越大

:::

### 反模式3：生产环境的手工配置管理

很多组织通过专门的运维来管理生产环境配置， 比如修改数据库连接、增加服务器线程池的线程数需要团队登录生产服务器修改。

这种反模式特征：

- 灰度环境成功，但生产环境失败
- 集群各节点行为不同。
- 运维团队需要为上线准备较长时间
- 系统无法回滚
- 直接修改生产环境，风险较大。

:::tip

对于测试、灰度、生产都须要自动化过程进行版本控制及元素配置。

对于任何环境都应该完全掌握任何信息， 每次变更都会被记录， 对于程序之间也要知道依赖关系， 而这些

**自动化**是关键， 也应该在部署出错后自动化回滚版本。

:::


## 候选发布版本

候选发布版本(release candidate)是对于**代码的每一次提交都有被发布出去的可能性**。

传统软件开发中，通常较长时间来验证软件是否满足全部功能需求， 根据经验，如果是开发阶段结束后才做测试，会降低app的质量。

缺陷发现的越晚，那么修复的成本越高。 开发人员的代码回顾成本、需求不断修改的成本、后期交付工期的压迫会导致app的质量严重下降。

:::tip

每次提交代码都可能产生一个候补发布版本。

:::

上述描述的开发后才测试这个阶段叫做**集成测试(integration)阶段**, 也是整个项目中最不容易管理、预测的阶段。 

团队通常会推迟集成工作， 因为这件事情会比较痛苦， 但是经验来说解决痛快的办法就是更频繁的去做，而不是回避。

做到每次提交修改都做集成，做到**持续集成**(continuous integration)， 也就是CI/CD的CI部分。

## 软件交付原则

书中作者过去多年项目证明一下的原则如果没有遵循， 那么交付流程会变得复杂、低效。

### 1. 创建一个重复且可靠的过程

归根结底，软件部署分为三件事：

- 提供并管理软件需要的运行环境，包含了硬件配置、软件依赖、基础设备和外部服务
- 将app正确的版本正确的安装在运行环境上
- 配置app，包含它所需要的任何数据、状态。

核心为： **一是所有事情都自动化**， **二是构建、部署、测试、发布全部纳入版本控制**

:::info

后续会详细讲述实现这一原则的策略

:::

### 2. 所有事情自动化

有些事情不可能被自动化比如 探索性测试、UAT演示、人工审批流等。 但是这类事情其实比想象的少得多。

通常来说，当人需要做决策的时候，那么整个构建过程就是自动化的。

如验收测试、数据库升级降级、打包编译及提交服务器。

:::tip

足够的能力和时间才可以将全部自动化，可以渐进式实现，随后全部环节转变为自动化。

:::

### 3. 所有东西纳入版本控制

### 4. 提前并频繁做痛苦的事情

这是最通用的原则，也是最有启发性的。 如果一件事情很痛苦，那么就尽量在项目的开始就去做尝试并做到自动化替换你的痛苦

### 5. 内建质量

这一原则和上一原则都是从**精益运动**借鉴而来。

测试如果是开发结束后才开始，那么为时晚矣。

如果测试只是针对测试人员的，那么交付团队的其他人都是对项目的不负责。

### 6. DONE则意味着发布

没有完成80%的工作， 预估工作量永远都是预估，是不准确的。

只有DONE和TODO的事情。

### 7. 交付过程是每一个人都参与的

有些公司项目测试人员、开发人员、运维人员都对立的， 测试人员是对开发人员的针对者，又将发布的困难留给了运维人员。

系统中，每个人都应该知道app所处状态，整个系统是大家执行完成作业的动作。 这是devops运行的核心原则之一。

为了更加快速和可靠的交付有价值的软件。

### 8. 持续改进

戴明环圈是一个持续改进的过程， 也是精益运动的核心。分为 计划-执行-检查-处理(PDCA)四个阶段。

交付过程，整个团队应该定期坐在一起，回顾项目过往以及统筹未来。

#  配置管理







